<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Momentum Habit Tracker</title>
  <link rel="icon" type="image/png" href="icon.png">

  <!-- Immediate theme check to prevent flash of light mode -->
  <script>
    (function() {
      if (localStorage.getItem('themepreference') === 'dark' ||
         (!('themepreference' in localStorage) &&
          window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    })();
  </script>

  <!-- Immediate auth check to prevent login page flash for authenticated users -->
  <script>
    (function() {
      // Check localStorage for session (localStorage mode)
      var session = localStorage.getItem('momentum_session');
      if (session) {
        try {
          var sessionData = JSON.parse(session);
          // If user is authenticated, redirect immediately (before page renders)
          if (sessionData && sessionData.username) {
            console.log('Immediate redirect: localStorage session found');
            window.location.replace('app.html');
            return;
          }
        } catch (e) {
          // Invalid session data, continue to login page
        }
      }

      // Check Firebase authentication persistence
      // Firebase stores auth state in indexedDB or localStorage with keys starting with 'firebase:authUser:'
      // This is a quick synchronous check that works before Firebase SDK loads
      try {
        var hasFirebaseAuth = false;
        // Check for Firebase auth persistence in localStorage
        for (var i = 0; i < localStorage.length; i++) {
          var key = localStorage.key(i);
          if (key && key.startsWith('firebase:authUser:')) {
            var authData = localStorage.getItem(key);
            if (authData && authData !== 'null') {
              console.log('Immediate redirect: Firebase auth persistence found');
              hasFirebaseAuth = true;
              window.location.replace('app.html');
              return;
            }
          }
        }
      } catch (e) {
        console.log('Firebase auth check failed:', e);
        // Continue to show login page
      }

      // User not authenticated, show the login page
      document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('show-login');
      });
    })();
  </script>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind utilities -->
  <script>
    window.tailwind = { config: { darkMode: "class", corePlugins: { preflight: false } } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- App styles -->
  <link rel="stylesheet" href="styles.css">

  <style>
    /* Hide login page by default to prevent flash before redirect */
    body {
      opacity: 0;
      transition: opacity 0.15s ease-in;
    }

    body.show-login {
      opacity: 1;
    }

    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: var(--bg);
    }

    .login-card {
      background: var(--card);
      border: 1px solid var(--surface-muted);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow-card);
      width: 100%;
      max-width: 420px;
      padding: 40px 32px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      display: block;
      border-radius: 16px;
    }

    .login-title {
      font-size: 32px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .login-subtitle {
      font-size: 16px;
      color: var(--muted);
      font-weight: 500;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
    }

    .form-group .input {
      width: 100%;
      box-sizing: border-box;
    }

    .login-footer {
      margin-top: 24px;
      text-align: center;
    }

    .register-link {
      font-size: 14px;
      color: var(--muted);
    }

    .register-link a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }

    .register-link a:hover {
      text-decoration: underline;
    }

    .theme-toggle-login {
      position: fixed;
      top: 20px;
      right: 20px;
    }

    .error-message {
      background: rgba(220, 38, 38, 0.1);
      border: 1px solid rgba(220, 38, 38, 0.3);
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .divider-with-text {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 24px 0 20px;
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
    }

    .divider-with-text::before,
    .divider-with-text::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid var(--border);
    }

    .divider-with-text span {
      padding: 0 16px;
    }

    .btn-google {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 12px 18px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--card);
      color: var(--text);
      font-size: 1rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .btn-google:hover {
      background: var(--surface-frost);
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .btn-google:active {
      transform: scale(0.98);
    }

    .btn-google svg {
      flex-shrink: 0;
    }

    html.dark .btn-google {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.15);
    }

    html.dark .btn-google:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--primary);
    }
  </style>
</head>
<body>
  <button id="theme-toggle-login" class="control-btn theme-toggle theme-toggle-login" aria-label="Switch theme" title="Switch theme">
    <svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    <svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
  </button>

  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <img src="icon.png" alt="Momentum" class="login-logo">
        <h1 class="login-title">Momentum</h1>
        <p class="login-subtitle">Track your habits, build your momentum</p>
      </div>

      <div class="error-message" id="error-message"></div>

      <form class="login-form" id="login-form">
        <div class="form-group">
          <label for="username" id="username-label">Email</label>
          <input
            type="email"
            id="username"
            class="input"
            placeholder="Enter your email"
            required
            autocomplete="email"
          >
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input
            type="password"
            id="password"
            class="input"
            placeholder="Enter your password"
            required
            autocomplete="current-password"
          >
        </div>

        <div class="form-group" id="confirm-password-group" style="display: none;">
          <label for="confirm-password">Confirm Password</label>
          <input
            type="password"
            id="confirm-password"
            class="input"
            placeholder="Confirm your password"
            autocomplete="new-password"
          >
        </div>

        <button type="submit" class="btn primary" style="width: 100%; margin-top: 8px;">
          Log In
        </button>
      </form>

      <div class="divider-with-text" id="google-divider">
        <span>or</span>
      </div>

      <button type="button" class="btn-google" id="google-login">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.64 9.20454C17.64 8.56636 17.5827 7.95272 17.4764 7.36363H9V10.845H13.8436C13.635 11.97 13.0009 12.9231 12.0477 13.5613V15.8195H14.9564C16.6582 14.2527 17.64 11.9454 17.64 9.20454Z" fill="#4285F4"/>
          <path d="M9 18C11.43 18 13.4673 17.1941 14.9564 15.8195L12.0477 13.5613C11.2418 14.1013 10.2109 14.4204 9 14.4204C6.65591 14.4204 4.67182 12.8372 3.96409 10.71H0.957275V13.0418C2.43818 15.9831 5.48182 18 9 18Z" fill="#34A853"/>
          <path d="M3.96409 10.71C3.78409 10.17 3.68182 9.59318 3.68182 9C3.68182 8.40682 3.78409 7.83 3.96409 7.29V4.95818H0.957275C0.347727 6.17318 0 7.54772 0 9C0 10.4523 0.347727 11.8268 0.957275 13.0418L3.96409 10.71Z" fill="#FBBC05"/>
          <path d="M9 3.57955C10.3214 3.57955 11.5077 4.03364 12.4405 4.92545L15.0218 2.34409C13.4632 0.891818 11.4259 0 9 0C5.48182 0 2.43818 2.01682 0.957275 4.95818L3.96409 7.29C4.67182 5.16273 6.65591 3.57955 9 3.57955Z" fill="#EA4335"/>
        </svg>
        <span>Continue with Google</span>
      </button>

      <div class="login-footer">
        <p class="register-link">
          Don't have an account? <a href="#" id="register-link">Create one</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Login module (loads Firebase SDK and Auth as ES modules) -->
  <script type="module" src="js/login.js"></script>
</body>
</html>
